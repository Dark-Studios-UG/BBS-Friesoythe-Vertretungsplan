<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="das.webp">
    <title>Vertretungsplan</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Vertretungsplan</h1>
        <h2 id="date"></h2>
        <div class="controls">
            <div class="button-group">
                <button id="todayButton">Heute</button>
                <button id="tomorrowButton">Morgen</button>
            </div>
            <select id="courseFilter">
                <option value="all">Wähle einen Kurs</option>
                <!-- Kurse werden hier dynamisch hinzugefügt -->
            </select>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Kurs</th>
                        <th>Stunde</th>
                        <th>Raum</th>
                        <th>Lehrer</th>
                        <th>Typ</th>
                        <th>Notizen</th>
                    </tr>
                </thead>
                <tbody id="data-body">
                    <!-- Daten werden hier eingefügt -->
                </tbody>
            </table>
        </div>
    </div>
    <script>
        // Aktuelles Datum im Format Wochentag, TT.MM.JJJJ
        const today = new Date();
        const currentHour = today.getHours(); // Aktuelle Stunde

        // Überprüfe, ob die aktuelle Stunde 17 oder später ist
        if (currentHour >= 17) {
            today.setDate(today.getDate() + 1); // Setze das Datum auf morgen
        }

        const options = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
        document.getElementById('date').textContent = today.toLocaleDateString('de-DE', options);

        // Setze das Datum auf heute oder morgen
        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1); // Setze das Datum auf morgen

        // Funktion zum Setzen des Datums
        const setDate = (date) => {
            document.getElementById('date').textContent = date.toLocaleDateString('de-DE', options);
        };

        // Event Listener für die Schaltflächen
        document.getElementById('todayButton').addEventListener('click', () => {
            setDate(today);
            setActiveButton('today');
            fetchCourses();
        });

        document.getElementById('tomorrowButton').addEventListener('click', () => {
            setDate(tomorrow);
            setActiveButton('tomorrow');
            fetchMorgenData();
        });

        // Funktion zum Setzen des aktiven Buttons
        const setActiveButton = (active) => {
            const todayButton = document.getElementById('todayButton');
            const tomorrowButton = document.getElementById('tomorrowButton');

            if (active === 'today') {
                todayButton.classList.add('active');
                tomorrowButton.classList.remove('active');
            } else {
                tomorrowButton.classList.add('active');
                todayButton.classList.remove('active');
            }
        };

        let allData = []; // Variable zum Speichern der gescrapten Daten

        // Funktion zum Speichern des ausgewählten Kurses
        const saveSelectedCourse = (course) => {
            localStorage.setItem('selectedCourse', course);
        };

        // Funktion zum Laden des gespeicherten Kurses
        const loadSelectedCourse = () => {
            return localStorage.getItem('selectedCourse') || 'all';
        };

        // Daten filtern
        const filterData = () => {
            const selectedCourse = document.getElementById('courseFilter').value;
            
            // Speichere den ausgewählten Kurs
            saveSelectedCourse(selectedCourse);
            
            if (selectedCourse === 'all') {
                renderData(allData);
            } else {
                const filteredData = allData.filter(item => {
                    return item.kurs.trim() === selectedCourse.trim();
                });
                renderData(filteredData);
            }
        };

        // Funktion zum Anzeigen einer Fehlermeldung
        const showError = (message) => {
            const tbody = document.getElementById('data-body');
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">${message}</td></tr>`;
        };

        // Kurse von der API für heute abrufen
        const fetchCourses = () => {
            fetch('/api/data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Netzwerkantwort war nicht ok');
                    }
                    return response.json();
                })
                .then(response => {
                    allData = response.data.filter(item => item.kurs && item.kurs.trim() !== '');
                    const uniqueCourses = [...new Set(allData.map(item => item.kurs))].sort();
                    
                    const courseFilter = document.getElementById('courseFilter');
                    courseFilter.innerHTML = '<option value="all">Wähle einen Kurs</option>';

                    uniqueCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        courseFilter.appendChild(option);
                    });

                    const savedCourse = loadSelectedCourse();
                    if (uniqueCourses.includes(savedCourse) || savedCourse === 'all') {
                        courseFilter.value = savedCourse;
                        filterData();
                    } else {
                        renderData(allData);
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Abrufen der Kurse:', error);
                    showError('Keine Daten verfügbar');
                });
        };

        // Kurse von der API für morgen abrufen
        const fetchMorgenData = () => {
            fetch('/api/morgen')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Netzwerkantwort war nicht ok');
                    }
                    return response.json();
                })
                .then(data => {
                    allData = data.data.filter(item => item.kurs && item.kurs.trim() !== '');
                    const uniqueCourses = [...new Set(allData.map(item => item.kurs))].sort();
                    
                    const courseFilter = document.getElementById('courseFilter');
                    courseFilter.innerHTML = '<option value="all">Wähle einen Kurs</option>';

                    uniqueCourses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        courseFilter.appendChild(option);
                    });

                    const savedCourse = loadSelectedCourse();
                    if (uniqueCourses.includes(savedCourse) || savedCourse === 'all') {
                        courseFilter.value = savedCourse;
                        filterData();
                    } else {
                        renderData(allData);
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Abrufen der Morgen-Daten:', error);
                    showError('Keine Daten für morgen verfügbar');
                });
        };

        // Daten rendern
        const renderData = (data) => {
            const tbody = document.getElementById('data-body');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Keine Daten verfügbar</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.kurs || '-'}</td>
                    <td>${item.stunde || '-'}</td>
                    <td>${item.raum || '-'}</td>
                    <td>${item.lehrer || '-'}</td>
                    <td>${item.typ || '-'}</td>
                    <td>${item.notizen || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        };

        // Event Listener für das Kurs-Dropdown
        document.getElementById('courseFilter').addEventListener('change', filterData);

        // Setze den initialen aktiven Button
        setActiveButton('today');

        // Initiale Kurse und Daten abrufen
        fetchCourses();
    </script>
</body>
</html>
