<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Vertretungsplan der BBS Friesoythe">
    <meta name="theme-color" content="#f4f4f4">
    <link rel="icon" type="image/png" href="das.webp">
    <title>Vertretungsplan</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Vertretungsplan</h1>
        <h2 id="date"></h2>
        <div class="controls">
            <div class="button-group">
                <button id="todayButton">Heute</button>
                <button id="tomorrowButton">Morgen</button>
                <button id="allDaysButton">Beide</button>
            </div>
            <select id="courseFilter">
                <option value="all">Wähle einen Kurs</option>
            </select>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="kurs">Kurs</th>
                        <th data-sort="datum" class="date-column">Tag</th>
                        <th data-sort="stunde">Stunde</th>
                        <th data-sort="raum">Raum</th>
                        <th data-sort="lehrer">Lehrer</th>
                        <th data-sort="typ">Typ</th>
                        <th data-sort="notizen">Notizen</th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>
        </div>
        <footer class="footer">
            <div class="footer-links">
                <a href="https://github.com/Dark-Studios-UG/BBS-Friesoythe-Vertretungsplan" target="_blank" rel="noopener">GitHub</a>
                <a href="https://forms.gle/SdA2HfNGgqiHhsoa9" target="_blank" rel="noopener">Verbesserungsvorschläge</a>
                <a href="https://darkstudios.de/sections/imprint.html" target="_blank" rel="noopener">Impressum</a>
                <a href="https://darkstudios.de/sections/privacy.html" target="_blank" rel="noopener">Datenschutz</a>
            </div>
        </footer>
    </div>
    <script>
        // Konstanten
        const API = {
            TODAY: '/api/data',
            TOMORROW: '/api/morgen',
            BOTH: '/api/both'
        };

        const STORAGE_KEYS = {
            SELECTED_COURSE: 'selectedCourse',
            SELECTED_VIEW: 'selectedView'
        };

        const DOM = {
            date: document.getElementById('date'),
            todayButton: document.getElementById('todayButton'),
            tomorrowButton: document.getElementById('tomorrowButton'),
            allDaysButton: document.getElementById('allDaysButton'),
            courseFilter: document.getElementById('courseFilter'),
            dataBody: document.getElementById('data-body')
        };

        // Datum-Management
        class DateManager {
            static SWITCH_HOUR = 17;

            static getCurrentDate() {
                const today = new Date();
                if (today.getHours() >= this.SWITCH_HOUR) {
                    today.setDate(today.getDate() + 1);
                }
                return today;
            }

            static getTomorrowDate() {
                const tomorrow = new Date(this.getCurrentDate());
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow;
            }

            static formatDate(date) {
                const options = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
                return date.toLocaleDateString('de-DE', options);
            }

            static formatDateShort(date) {
                const options = { weekday: 'long' };
                return date.toLocaleDateString('de-DE', options);
            }

            static formatDateFromString(dateStr) {
                const date = new Date(dateStr);
                return this.formatDateShort(date);
            }
        }

        // Daten-Management
        class DataManager {
            static allData = [];
            static currentSortColumn = null;
            static isAscending = true;
            static currentView = 'today'; // 'today', 'tomorrow', or 'both'

            static async fetchData(view = 'today') {
                try {
                    const response = await fetch(
                        view === 'today' ? API.TODAY : 
                        view === 'tomorrow' ? API.TOMORROW : API.BOTH
                    );
                    if (!response.ok) throw new Error('Netzwerkantwort war nicht ok');
                    
                    const data = await response.json();
                    // Filtere leere oder nur aus Leerzeichen bestehende Kurse
                    this.allData = data.data.filter(item => item.kurs?.trim());
                    this.currentView = view;
                    return {
                        data: this.allData,
                        courses: data.courses.filter(Boolean).sort()
                    };
                } catch (error) {
                    console.error('Fehler beim Abrufen der Daten:', error);
                    throw error;
                }
            }

            static filterData(selectedCourse) {
                let filteredData = selectedCourse === 'all' 
                    ? this.allData 
                    : this.allData.filter(item => item.kurs.trim() === selectedCourse.trim());
                
                if (this.currentSortColumn) {
                    filteredData = this.sortData(filteredData, this.currentSortColumn, this.isAscending);
                }
                
                return filteredData;
            }

            static sortData(data, column, ascending) {
                return [...data].sort((a, b) => {
                    const aVal = (a[column] || '').toString().trim().toLowerCase();
                    const bVal = (b[column] || '').toString().trim().toLowerCase();
                    
                    // Numerische Sortierung für die Stunde
                    if (column === 'stunde') {
                        const aNum = parseInt(aVal) || 0;
                        const bNum = parseInt(bVal) || 0;
                        return ascending ? aNum - bNum : bNum - aNum;
                    }
                    
                    // Alphabetische Sortierung für andere Spalten
                    return ascending 
                        ? aVal.localeCompare(bVal) 
                        : bVal.localeCompare(aVal);
                });
            }
        }

        // UI-Management
        class UIManager {
            static updateDateDisplay(date, view = 'today') {
                if (view === 'both') {
                    const today = DateManager.getCurrentDate();
                    const tomorrow = DateManager.getTomorrowDate();
                    DOM.date.textContent = `${DateManager.formatDate(today)} und ${DateManager.formatDate(tomorrow)}`;
                } else {
                    DOM.date.textContent = DateManager.formatDate(date);
                }

                // Zeige/Verstecke die Datumsspalte
                document.querySelectorAll('.date-column').forEach(el => {
                    el.style.display = view === 'both' ? '' : 'none';
                });
            }

            static setActiveButton(view) {
                DOM.todayButton.classList.toggle('active', view === 'today');
                DOM.tomorrowButton.classList.toggle('active', view === 'tomorrow');
                DOM.allDaysButton.classList.toggle('active', view === 'both');
            }

            static updateCourseFilter(courses) {
                DOM.courseFilter.innerHTML = '<option value="all">Wähle einen Kurs</option>';
                courses.sort().forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    DOM.courseFilter.appendChild(option);
                });
            }

            static updateSortIndicators(column) {
                const headers = document.querySelectorAll('th');
                headers.forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                    if (header.dataset.sort === column) {
                        header.classList.add(
                            DataManager.isAscending ? 'sorted-asc' : 'sorted-desc'
                        );
                    }
                });
            }

            static renderData(data) {
                if (!data || data.length === 0) {
                    this.showMessage('Keine Daten verfügbar');
                    return;
                }

                DOM.dataBody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.kurs || '-'}</td>
                        <td class="date-column" ${DataManager.currentView !== 'both' ? 'style="display:none"' : ''}>
                            ${item.datum ? DateManager.formatDateFromString(item.datum) : '-'}
                        </td>
                        <td>${item.stunde || '-'}</td>
                        <td>${item.raum || '-'}</td>
                        <td>${item.lehrer || '-'}</td>
                        <td>${item.typ || '-'}</td>
                        <td>${item.notizen || '-'}</td>
                    `;
                    DOM.dataBody.appendChild(row);
                });
            }

            static showMessage(message) {
                const colspan = DataManager.currentView === 'both' ? 7 : 6;
                DOM.dataBody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" style="text-align: center; padding: 20px;">
                            ${message}
                        </td>
                    </tr>
                `;
            }
        }

        // Storage-Management
        class StorageManager {
            static saveSelectedCourse(course) {
                localStorage.setItem(STORAGE_KEYS.SELECTED_COURSE, course);
                this.updateUrlHash();
            }

            static saveSelectedView(view) {
                localStorage.setItem(STORAGE_KEYS.SELECTED_VIEW, view);
                this.updateUrlHash();
            }

            static loadSelectedCourse() {
                const hash = this.parseUrlHash();
                if (hash.course) {
                    return decodeURIComponent(hash.course);
                }
                return localStorage.getItem(STORAGE_KEYS.SELECTED_COURSE) || 'all';
            }

            static loadSelectedView() {
                const hash = this.parseUrlHash();
                if (hash.view) {
                    return hash.view;
                }
                return localStorage.getItem(STORAGE_KEYS.SELECTED_VIEW) || 'today';
            }

            static parseUrlHash() {
                const hash = window.location.hash.slice(1);
                const parts = hash.split(';');
                const result = { course: null, view: null };
                
                parts.forEach(part => {
                    if (part.startsWith('view=')) {
                        result.view = part.split('=')[1];
                    } else if (part) {
                        result.course = part;
                    }
                });
                
                return result;
            }

            static updateUrlHash() {
                const course = localStorage.getItem(STORAGE_KEYS.SELECTED_COURSE);
                const view = localStorage.getItem(STORAGE_KEYS.SELECTED_VIEW);
                let hash = '';

                if (course && course !== 'all') {
                    hash = course;
                }
                if (view && view !== 'today') {
                    hash = hash ? `${hash};view=${view}` : `view=${view}`;
                }

                if (hash) {
                    window.location.hash = hash;
                } else {
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                }
            }
        }

        // Event-Handler
        class EventHandler {
            static async init() {
                DOM.todayButton.addEventListener('click', () => this.handleDateChange('today'));
                DOM.tomorrowButton.addEventListener('click', () => this.handleDateChange('tomorrow'));
                DOM.allDaysButton.addEventListener('click', () => this.handleDateChange('both'));
                DOM.courseFilter.addEventListener('change', () => this.handleCourseChange());

                // Listen for hash changes
                window.addEventListener('hashchange', () => this.handleHashChange());

                // Sortier-Event-Listener hinzufügen
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.addEventListener('click', () => this.handleSort(header.dataset.sort));
                });

                // Initial load - use view from hash or storage
                const initialView = StorageManager.loadSelectedView();
                await this.handleDateChange(initialView);
            }

            static async handleDateChange(view) {
                try {
                    StorageManager.saveSelectedView(view);
                    UIManager.setActiveButton(view);
                    if (view === 'both') {
                        UIManager.updateDateDisplay(null, 'both');
                    } else {
                        UIManager.updateDateDisplay(
                            view === 'today' ? DateManager.getCurrentDate() : DateManager.getTomorrowDate(),
                            view
                        );
                    }

                    const data = await DataManager.fetchData(view);
                    UIManager.updateCourseFilter(data.courses);

                    const hashData = StorageManager.parseUrlHash();
                    if (hashData.course && data.courses.includes(hashData.course)) {
                        DOM.courseFilter.value = hashData.course;
                    } else {
                        const savedCourse = StorageManager.loadSelectedCourse();
                        if (data.courses.includes(savedCourse) || savedCourse === 'all') {
                            DOM.courseFilter.value = savedCourse;
                        } else {
                            DOM.courseFilter.value = 'all';
                        }
                    }
                    this.handleCourseChange();
                } catch (error) {
                    console.error('Fehler beim Laden der Daten:', error);
                    UIManager.showMessage('Fehler beim Laden der Daten');
                }
            }

            static handleCourseChange() {
                const selectedCourse = DOM.courseFilter.value;
                StorageManager.saveSelectedCourse(selectedCourse);
                const filteredData = DataManager.filterData(selectedCourse);
                UIManager.renderData(filteredData);
            }

            static handleHashChange() {
                const hashData = StorageManager.parseUrlHash();
                const view = hashData.view || 'today';
                this.handleDateChange(view);
            }

            static handleSort(column) {
                if (DataManager.currentSortColumn === column) {
                    DataManager.isAscending = !DataManager.isAscending;
                } else {
                    DataManager.currentSortColumn = column;
                    DataManager.isAscending = true;
                }

                UIManager.updateSortIndicators(column);
                this.handleCourseChange();
            }
        }

        // Anwendung starten
        EventHandler.init();
    </script>
</body>
</html>
