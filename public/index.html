<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Vertretungsplan der BBS Friesoythe">
    <meta name="theme-color" content="#f4f4f4">
    <link rel="icon" type="image/png" href="das.webp">
    <title>Vertretungsplan</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Vertretungsplan</h1>
        <h2 id="date"></h2>
        <div class="controls">
            <div class="button-group">
                <button id="todayButton">Heute</button>
                <button id="tomorrowButton">Morgen</button>
            </div>
            <select id="courseFilter">
                <option value="all">Wähle einen Kurs</option>
            </select>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="kurs">Kurs</th>
                        <th data-sort="stunde">Stunde</th>
                        <th data-sort="raum">Raum</th>
                        <th data-sort="lehrer">Lehrer</th>
                        <th data-sort="typ">Typ</th>
                        <th data-sort="notizen">Notizen</th>
                    </tr>
                </thead>
                <tbody id="data-body"></tbody>
            </table>
        </div>
        <footer class="footer">
            <div class="footer-links">
                <a href="https://github.com/Dark-Studios-UG/BBS-Friesoythe-Vertretungsplan" target="_blank" rel="noopener">GitHub</a>
                <a href="https://darkstudios.de/sections/imprint.html" target="_blank" rel="noopener">Impressum</a>
                <a href="https://darkstudios.de/sections/privacy.html" target="_blank" rel="noopener">Datenschutz</a>
            </div>
        </footer>
    </div>
    <script>
        // Konstanten
        const API = {
            TODAY: '/api/data',
            TOMORROW: '/api/morgen'
        };

        const STORAGE_KEYS = {
            SELECTED_COURSE: 'selectedCourse'
        };

        const DOM = {
            date: document.getElementById('date'),
            todayButton: document.getElementById('todayButton'),
            tomorrowButton: document.getElementById('tomorrowButton'),
            courseFilter: document.getElementById('courseFilter'),
            dataBody: document.getElementById('data-body')
        };

        // Datum-Management
        class DateManager {
            static SWITCH_HOUR = 17;

            static getCurrentDate() {
                const today = new Date();
                if (today.getHours() >= this.SWITCH_HOUR) {
                    today.setDate(today.getDate() + 1);
                }
                return today;
            }

            static getTomorrowDate() {
                const tomorrow = new Date(this.getCurrentDate());
                tomorrow.setDate(tomorrow.getDate() + 1);
                return tomorrow;
            }

            static formatDate(date) {
                const options = { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' };
                return date.toLocaleDateString('de-DE', options);
            }
        }

        // Daten-Management
        class DataManager {
            static allData = [];
            static currentSortColumn = null;
            static isAscending = true;

            static async fetchData(isToday = true) {
                try {
                    const response = await fetch(isToday ? API.TODAY : API.TOMORROW);
                    if (!response.ok) throw new Error('Netzwerkantwort war nicht ok');
                    
                    const data = await response.json();
                    // Filtere leere oder nur aus Leerzeichen bestehende Kurse
                    this.allData = data.data.filter(item => item.kurs?.trim());
                    return {
                        data: this.allData,
                        // Entferne Duplikate und leere Kurse
                        courses: [...new Set(this.allData.map(item => item.kurs.trim()))].filter(Boolean).sort()
                    };
                } catch (error) {
                    console.error('Fehler beim Abrufen der Daten:', error);
                    throw error;
                }
            }

            static filterData(selectedCourse) {
                let filteredData = selectedCourse === 'all' 
                    ? this.allData 
                    : this.allData.filter(item => item.kurs.trim() === selectedCourse.trim());
                
                if (this.currentSortColumn) {
                    filteredData = this.sortData(filteredData, this.currentSortColumn, this.isAscending);
                }
                
                return filteredData;
            }

            static sortData(data, column, ascending) {
                return [...data].sort((a, b) => {
                    const aVal = (a[column] || '').toString().trim().toLowerCase();
                    const bVal = (b[column] || '').toString().trim().toLowerCase();
                    
                    // Numerische Sortierung für die Stunde
                    if (column === 'stunde') {
                        const aNum = parseInt(aVal) || 0;
                        const bNum = parseInt(bVal) || 0;
                        return ascending ? aNum - bNum : bNum - aNum;
                    }
                    
                    // Alphabetische Sortierung für andere Spalten
                    return ascending 
                        ? aVal.localeCompare(bVal) 
                        : bVal.localeCompare(aVal);
                });
            }
        }

        // UI-Management
        class UIManager {
            static updateDateDisplay(date) {
                DOM.date.textContent = DateManager.formatDate(date);
            }

            static setActiveButton(isToday) {
                DOM.todayButton.classList.toggle('active', isToday);
                DOM.tomorrowButton.classList.toggle('active', !isToday);
            }

            static updateCourseFilter(courses) {
                DOM.courseFilter.innerHTML = '<option value="all">Wähle einen Kurs</option>';
                courses.sort().forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    DOM.courseFilter.appendChild(option);
                });
            }

            static updateSortIndicators(column) {
                const headers = document.querySelectorAll('th');
                headers.forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                    if (header.dataset.sort === column) {
                        header.classList.add(
                            DataManager.isAscending ? 'sorted-asc' : 'sorted-desc'
                        );
                    }
                });
            }

            static renderData(data) {
                if (!data || data.length === 0) {
                    this.showMessage('Keine Daten verfügbar');
                    return;
                }

                DOM.dataBody.innerHTML = '';
                data.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.kurs || '-'}</td>
                        <td>${item.stunde || '-'}</td>
                        <td>${item.raum || '-'}</td>
                        <td>${item.lehrer || '-'}</td>
                        <td>${item.typ || '-'}</td>
                        <td>${item.notizen || '-'}</td>
                    `;
                    DOM.dataBody.appendChild(row);
                });
            }

            static showMessage(message) {
                DOM.dataBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px;">
                            ${message}
                        </td>
                    </tr>
                `;
            }
        }

        // Storage-Management
        class StorageManager {
            static saveSelectedCourse(course) {
                localStorage.setItem(STORAGE_KEYS.SELECTED_COURSE, course);
            }

            static loadSelectedCourse() {
                return localStorage.getItem(STORAGE_KEYS.SELECTED_COURSE) || 'all';
            }
        }

        // Event-Handler
        class EventHandler {
            static async init() {
                DOM.todayButton.addEventListener('click', () => this.handleDateChange(true));
                DOM.tomorrowButton.addEventListener('click', () => this.handleDateChange(false));
                DOM.courseFilter.addEventListener('change', () => this.handleCourseChange());

                // Sortier-Event-Listener hinzufügen
                document.querySelectorAll('th[data-sort]').forEach(header => {
                    header.addEventListener('click', () => this.handleSort(header.dataset.sort));
                });

                // Initial load
                await this.handleDateChange(true);
            }

            static async handleDateChange(isToday) {
                try {
                    UIManager.setActiveButton(isToday);
                    UIManager.updateDateDisplay(
                        isToday ? DateManager.getCurrentDate() : DateManager.getTomorrowDate()
                    );

                    const data = await DataManager.fetchData(isToday);
                    UIManager.updateCourseFilter(data.courses);

                    const savedCourse = StorageManager.loadSelectedCourse();
                    if (data.courses.includes(savedCourse) || savedCourse === 'all') {
                        DOM.courseFilter.value = savedCourse;
                        this.handleCourseChange();
                    } else {
                        UIManager.renderData(DataManager.allData);
                    }
                } catch (error) {
                    UIManager.showMessage('Fehler beim Laden der Daten');
                }
            }

            static handleCourseChange() {
                const selectedCourse = DOM.courseFilter.value;
                StorageManager.saveSelectedCourse(selectedCourse);
                UIManager.renderData(DataManager.filterData(selectedCourse));
            }

            static handleSort(column) {
                if (DataManager.currentSortColumn === column) {
                    DataManager.isAscending = !DataManager.isAscending;
                } else {
                    DataManager.currentSortColumn = column;
                    DataManager.isAscending = true;
                }

                UIManager.updateSortIndicators(column);
                UIManager.renderData(DataManager.filterData(DOM.courseFilter.value));
            }
        }

        // Anwendung starten
        EventHandler.init();
    </script>
</body>
</html>
